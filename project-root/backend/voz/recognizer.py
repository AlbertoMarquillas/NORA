"""
recognizer.py

Este m√≥dulo gestiona la captura de voz desde el micr√≥fono
y su conversi√≥n a texto mediante el motor de reconocimiento de Google.
La configuraci√≥n se extrae de definiciones.py
"""

import speech_recognition as sr
from voz.definiciones import (
    DEVICE_INDEX,
    ENERGY_THRESHOLD,
    PAUSE_THRESHOLD,
    PHRASE_TIME_LIMIT,
    TIMEOUT,
    DEBUG_VOZ
)

def escuchar_frase() -> str | None:
    """
    Escucha una frase del micr√≥fono y devuelve su transcripci√≥n en texto.

    Returns:
        str | None: El texto reconocido o None si no se pudo interpretar.
    """
    recognizer = sr.Recognizer()
    recognizer.energy_threshold = ENERGY_THRESHOLD
    recognizer.pause_threshold = PAUSE_THRESHOLD

    # Buscar √≠ndice del micr√≥fono "pulse"
    mic_name = "pulse"
    mic_index = next((i for i, name in enumerate(sr.Microphone.list_microphone_names())
                      if mic_name in name.lower()), None)

    if mic_index is None:
        if DEBUG_VOZ:
            print("‚ùå No se encontr√≥ el micr√≥fono con nombre 'pulse'.")
        return None

    try:
        with sr.Microphone(device_index=mic_index) as source:
            recognizer.adjust_for_ambient_noise(source, duration=1)
            if DEBUG_VOZ:
                print("üéß Escuchando por el micro...")

            audio = recognizer.listen(
                source,
                timeout=TIMEOUT,
                phrase_time_limit=PHRASE_TIME_LIMIT
            )
    except sr.WaitTimeoutError:
        if DEBUG_VOZ:
            print("‚è±Ô∏è No se detect√≥ voz durante el tiempo l√≠mite.")
        return None
    except Exception as e:
        if DEBUG_VOZ:
            print(f"‚ùå Error al acceder al micro: {e}")
        return None

    # Reconocimiento de texto
    try:
        texto = recognizer.recognize_google(audio, language="es-ES")
        if DEBUG_VOZ:
            print(f"üìù Frase reconocida: {texto}")
        return texto
    except sr.UnknownValueError:
        if DEBUG_VOZ:
            print("ü§î No se entendi√≥ lo que se dijo.")
        return None
    except sr.RequestError as e:
        if DEBUG_VOZ:
            print(f"üîå Error de conexi√≥n con el servicio de reconocimiento: {e}")
        return None
